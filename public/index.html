<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Solana 代币监控</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="/css/styles.css" rel="stylesheet">
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
</head>
<body class="bg-gray-100">
    <div id="app" class="container mx-auto px-4 py-8">
        <div class="fixed inset-x-0 top-0 flex justify-center z-50">
            <transition name="slide-fade">
                <div v-if="showCopyMessage" 
                     class="message-popup mt-4 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg">
                    <div class="flex items-center">
                        <svg class="w-5 h-5 mr-2 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                        </svg>
                        <span>地址已复制到剪贴板</span>
                    </div>
                </div>
            </transition>
        </div>
        <header class="mb-8 flex justify-between items-center">
            <div>
                <h1 class="text-3xl font-bold text-gray-800">Solana 代币监控</h1>
                <p class="text-gray-600">总数: {{ total }} 个代币</p>
            </div>
            <div class="text-sm text-gray-500">
                最后更新: {{ lastUpdate }}
            </div>
        </header>

        <!-- 使用 flex 布局将主内容和右侧重复列表并排 -->
        <div class="flex gap-6">
            <!-- 主要内容区域 -->
            <div class="flex-1">
                <!-- 标签页 -->
                <div class="mb-4 border-b border-gray-200">
                    <ul class="flex flex-wrap -mb-px">
                        <li class="mr-2">
                            <button @click="switchTab('all')"
                                    :class="[
                                        'inline-block py-2 px-4 text-sm font-medium rounded-t-lg',
                                        activeTab === 'all' 
                                            ? 'text-blue-600 border-b-2 border-blue-600' 
                                            : 'text-gray-500 hover:text-gray-600 hover:border-gray-300'
                                    ]">
                                所有代币
                            </button>
                        </li>
                        <li class="mr-2">
                            <button @click="switchTab('duplicates')"
                                    :class="[
                                        'inline-block py-2 px-4 text-sm font-medium rounded-t-lg',
                                        activeTab === 'duplicates'
                                            ? 'text-blue-600 border-b-2 border-blue-600'
                                            : 'text-gray-500 hover:text-gray-600 hover:border-gray-300'
                                    ]">
                                重复代币
                            </button>
                        </li>
                    </ul>
                </div>

                <!-- 加载和错误提示 -->
                <div class="mb-4">
                    <div v-if="loading" class="text-center py-4">
                        <svg class="animate-spin h-5 w-5 mx-auto text-blue-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        <p class="mt-2 text-gray-600">加载中...</p>
                    </div>

                    <div v-if="error" class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative" role="alert">
                        <strong class="font-bold">错误！</strong>
                        <span class="block sm:inline">{{ error }}</span>
                        <button @click="retryFetch" class="ml-4 text-sm underline">重试</button>
                    </div>
                </div>

                <!-- 代币列表表格 -->
                <div v-if="!loading && !error" class="bg-white rounded-lg shadow overflow-hidden">
                    <table class="min-w-full">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">代币符号</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">名称</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">代币地址</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">创建时间</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">社交媒体</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            <tr v-for="token in tokens" 
                                :key="token.mint" 
                                :class="[
                                    'hover:bg-gray-50 transition-all duration-200',
                                    getDuplicateColor(token)
                                ]">
                                <!-- 代币符号 -->
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <div class="flex items-center">
                                        <!-- 头像 -->
                                        <div class="flex-shrink-0 h-8 w-8">
                                            <img v-if="token.metadata?.image" 
                                                 :src="token.metadata.image"
                                                 class="h-8 w-8 rounded-full"
                                                 :alt="token.name"
                                                 loading="lazy"
                                                 @error="handleImageError($event, token)">
                                            <!-- 默认头像 -->
                                            <div v-else
                                                 class="h-8 w-8 rounded-full bg-gray-200 flex items-center justify-center">
                                                <span class="text-xs text-gray-500">{{ getInitials(token.name) }}</span>
                                            </div>
                                        </div>
                                        
                                        <!-- 符号 -->
                                        <div class="ml-4">
                                            <div class="text-sm font-medium text-gray-900">
                                                {{ token.symbol }}
                                            </div>
                                        </div>
                                    </div>
                                </td>
                                
                                <!-- 名称 -->
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <div class="text-sm text-gray-900">{{ token.name }}</div>
                                </td>
                                
                                <!-- 代币地址 -->
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <span @click="copyAddress(token.mint)"
                                          class="text-blue-600 hover:text-blue-900 cursor-pointer">
                                        {{ formatAddress(token.mint) }}
                                    </span>
                                </td>
                                
                                <!-- 创建时间 -->
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                    {{ formatTime(token.timestamp) }}
                                </td>

                                <!-- 社交媒体 -->
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <div class="flex items-center gap-2">
                                        <!-- 推特标签（如果存在） -->
                                        <span v-if="getTwitterLabel(token.metadata?.twitter)"
                                              :style="{
                                                  backgroundColor: getTwitterLabel(token.metadata?.twitter).color,
                                                  color: '#FFFFFF',
                                                  padding: '2px 8px',
                                                  borderRadius: '9999px',
                                                  fontSize: '0.75rem',
                                                  lineHeight: '1rem'
                                              }"
                                              class="inline-flex items-center">
                                            {{ getTwitterLabel(token.metadata?.twitter).label }}
                                        </span>

                                        <!-- 推特链接 -->
                                        <a v-if="token.metadata?.twitter"
                                           :href="token.metadata.twitter"
                                           target="_blank"
                                           class="inline-flex items-center"
                                           :class="[
                                               {
                                                   'text-green-500': isFullTwitterLink(token.metadata.twitter),
                                                   'text-yellow-500': isTwitterAccountLink(token.metadata.twitter),
                                                   'text-red-500': !isValidTwitterLink(token.metadata.twitter)
                                               }
                                           ]">
                                            <svg class="w-4 h-4 mr-1" fill="currentColor" viewBox="0 0 24 24">
                                                <path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/>
                                            </svg>
                                            <span class="text-xs">推特</span>
                                        </a>

                                        <!-- 电报链接 -->
                                        <a v-if="token.metadata?.telegram"
                                           :href="token.metadata.telegram"
                                           target="_blank"
                                           class="text-blue-500 hover:text-blue-600">
                                            <div class="flex items-center">
                                                <svg class="w-4 h-4" viewBox="0 0 24 24" fill="currentColor">
                                                    <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm4.64 6.8c-.15 1.58-.8 5.42-1.13 7.19-.14.75-.42 1-.68 1.03-.58.05-1.02-.38-1.58-.75-.88-.58-1.38-.94-2.23-1.5-.99-.65-.35-1.01.22-1.59.15-.15 2.71-2.48 2.76-2.69a.2.2 0 00-.05-.18c-.06-.05-.14-.03-.21-.02-.09.02-1.49.95-4.22 2.79-.4.27-.76.41-1.08.4-.36-.01-1.04-.2-1.55-.37-.63-.2-1.12-.31-1.08-.66.02-.18.27-.36.74-.55 2.92-1.27 4.86-2.11 5.83-2.51 2.78-1.16 3.35-1.36 3.73-1.36.08 0 .27.02.39.12.1.08.13.19.14.27-.01.06.01.24 0 .38z"/>
                                                </svg>
                                                <span class="ml-1 text-xs">电报</span>
                                            </div>
                                        </a>

                                        <!-- 网站链接 -->
                                        <a v-if="token.metadata?.website"
                                           :href="token.metadata.website"
                                           target="_blank"
                                           class="text-gray-500 hover:text-gray-600">
                                            <div class="flex items-center">
                                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 01-9 9m9-9a9 9 0 00-9-9m9 9H3m9 9a9 9 0 01-9-9m9 9c1.657 0 3-4.03 3-9s-1.343-9-3-9m0 18c-1.657 0-3-4.03-3-9s1.343-9 3-9m-9 9a9 9 0 019-9"/>
                                                </svg>
                                                <span class="ml-1 text-xs">网站</span>
                                            </div>
                                        </a>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- 分页控件 - 修改样式让它填充整个宽度 -->
                <div class="mt-4 bg-white rounded-lg shadow p-4">
                    <div class="flex justify-center items-center space-x-1">
                        <!-- 上一页按钮 -->
                        <button @click="currentPage > 1 && changePage(currentPage - 1)"
                                :disabled="currentPage === 1"
                                class="px-3 py-1 rounded text-sm"
                                :class="currentPage === 1 ? 'bg-gray-100 text-gray-400' : 'bg-white text-blue-500 hover:bg-blue-100'">
                            上一页
                        </button>

                        <!-- 页码按钮 -->
                        <button v-for="p in paginationRange" 
                                :key="p"
                                @click="p !== '...' && changePage(p)"
                                :class="[
                                    'px-3 py-1 rounded text-sm min-w-[32px]',
                                    {
                                        'bg-blue-500 text-white': currentPage === p,
                                        'bg-white text-blue-500 hover:bg-blue-100': currentPage !== p && p !== '...',
                                        'bg-gray-100 text-gray-600 cursor-default': p === '...'
                                    }
                                ]"
                                :disabled="p === '...'">
                            {{ p }}
                        </button>

                        <!-- 下一页按钮 -->
                        <button @click="currentPage < pages && changePage(currentPage + 1)"
                                :disabled="currentPage === pages"
                                class="px-3 py-1 rounded text-sm"
                                :class="currentPage === pages ? 'bg-gray-100 text-gray-400' : 'bg-white text-blue-500 hover:bg-blue-100'">
                            下一页
                        </button>
                    </div>

                    <!-- 添加页码信息 -->
                    <div class="mt-2 text-center text-sm text-gray-500">
                        第 {{ currentPage }} 页，共 {{ pages }} 页，总计 {{ total }} 条记录
                    </div>
                </div>
            </div>

            <!-- 右侧重复代币监控 -->
            <div class="w-80 flex-shrink-0">
                <div class="bg-white rounded-lg shadow p-4 sticky top-4">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-lg font-semibold">重复代币监控</h2>
                        <span class="text-xs text-gray-500">
                            最后检测: {{ formatMonitorTime() }}
                        </span>
                    </div>

                    <!-- 重复代币列表 -->
                    <div class="space-y-4">
                        <div v-if="duplicateTokens.length === 0" 
                             class="py-8 text-center text-gray-500">
                            <svg class="w-12 h-12 mx-auto mb-3 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                            </svg>
                            <p>暂无重复代币</p>
                            <p class="text-sm mt-2">持续监控中...</p>
                        </div>

                        <!-- 使用计算属性显示当前页的代币 -->
                        <div v-else v-for="group in paginatedDuplicateTokens" 
                             :key="group.groupNumber"
                             class="p-4 rounded-lg shadow-sm transition-all duration-200"
                             :class="getDuplicateColor(group)">
                            <!-- 代币基本信息 -->
                            <div class="flex items-center">
                                <div class="flex items-center flex-1">
                                    <img :src="group.metadata?.image" 
                                         :alt="group.symbol"
                                         class="w-10 h-10 rounded-full"
                                         @error="handleImageError">
                                    <div class="ml-3">
                                        <div class="font-medium text-gray-900">{{ group.symbol }}</div>
                                    </div>
                                </div>
                                <!-- 重复次数 -->
                                <div class="flex items-center cursor-pointer" 
                                     @click="showDuplicateGroupTokens(group)">
                                    <span class="text-sm text-gray-500 mr-1">重复次数:</span>
                                    <span class="bg-gray-100 text-gray-800 text-sm font-medium px-2.5 py-0.5 rounded-full hover:bg-gray-200 transition-colors">
                                        {{ group.count }}
                                    </span>
                                </div>
                            </div>

                            <!-- 时间信息 -->
                            <div class="mt-3 space-y-2 text-xs text-gray-500">
                                <div class="flex items-center">
                                    <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                                    </svg>
                                    <span class="font-medium">最新出现：</span>
                                    <span class="ml-1">{{ formatTime(group.latestTime) }}</span>
                                </div>
                                
                                <div v-if="group.previousTime" class="flex items-center">
                                    <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                                    </svg>
                                    <span class="font-medium">上次出现：</span>
                                    <span class="ml-1">{{ formatTime(group.previousTime) }}</span>
                                </div>

                                <div class="flex items-center">
                                    <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                                    </svg>
                                    <span class="font-medium">首次出现：</span>
                                    <span class="ml-1">{{ formatTime(group.firstTime) }}</span>
                                </div>
                            </div>

                            <!-- 重复类型和推特链接 -->
                            <div class="mt-2 flex items-center gap-2">
                                <!-- 重复类型标签 -->
                                <span class="text-xs px-2 py-1 rounded-full"
                                      :class="getDuplicateTypeClass(group.type)">
                                    {{ getDuplicateTypeText(group.type) }}
                                </span>
                                
                                <!-- 推特标签和链接组合 -->
                                <div v-if="group.twitterLink" class="flex items-center gap-1">
                                    <!-- 推特标签（使用原始颜色） -->
                                    <span v-if="getTwitterLabel(group.twitterLink)"
                                          :style="{
                                              backgroundColor: getTwitterLabel(group.twitterLink).color,
                                              color: '#FFFFFF',
                                              padding: '2px 8px',
                                              borderRadius: '9999px',
                                              fontSize: '0.75rem',
                                              lineHeight: '1rem'
                                          }"
                                          class="inline-flex items-center">
                                        {{ getTwitterLabel(group.twitterLink).label }}
                                    </span>
                                    
                                    <!-- X推特链接 -->
                                    <a :href="group.twitterLink"
                                       target="_blank"
                                       class="inline-flex items-center text-blue-500 hover:text-blue-600">
                                        <svg class="w-4 h-4 mr-1" fill="currentColor" viewBox="0 0 24 24">
                                            <path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/>
                                        </svg>
                                        <span class="text-xs">推特原文</span>
                                    </a>
                                </div>
                            </div>
                        </div>

                        <!-- 分页控件 -->
                        <div v-if="duplicateTokens.length > 0" 
                             class="mt-4 flex justify-center space-x-1">
                            <button v-for="p in duplicatePaginationRange" 
                                    :key="p"
                                    @click="changeDuplicatePage(p)"
                                    :class="[
                                        'px-2 py-1 text-xs rounded',
                                        {
                                            'bg-blue-500 text-white': duplicateCurrentPage === p,
                                            'bg-gray-100 text-gray-600 hover:bg-gray-200': duplicateCurrentPage !== p && p !== '...',
                                            'bg-gray-50 text-gray-400 cursor-not-allowed': p === '...'
                                        }
                                    ]"
                                    :disabled="p === '...'">
                                {{ p }}
                            </button>
                        </div>
                    </div>

                    <!-- 监控状态指示器 -->
                    <div class="mt-4 pt-4 border-t border-gray-200 flex items-center justify-between text-xs text-gray-500">
                        <span>监控状态</span>
                        <span class="flex items-center">
                            <span class="w-2 h-2 rounded-full bg-green-500 mr-2 animate-pulse"></span>
                            运行中
                        </span>
                    </div>
                </div>
            </div>
        </div>

        <!-- 在重复列表下方添加 -->
        <div class="mt-6 bg-white rounded-lg shadow p-4">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-semibold text-gray-800">推特标签管理</h3>
                <button @click="showLabelForm = true" 
                        class="px-3 py-1 bg-blue-500 text-white rounded hover:bg-blue-600">
                    添加标签
                </button>
            </div>
            
            <!-- 标签列表 -->
            <div class="space-y-3">
                <div v-for="label in twitterLabels" 
                     :key="label._id"
                     class="flex items-center justify-between p-3 bg-gray-50 rounded">
                    <div class="flex items-center space-x-3">
                        <span :style="{
                            backgroundColor: label.color,
                            color: '#FFFFFF',
                            padding: '2px 8px',
                            borderRadius: '4px'
                        }">{{ label.label }}</span>
                        <span class="text-sm text-gray-500">{{ label.twitterUrl }}</span>
                    </div>
                    <button @click="deleteTwitterLabel(label._id)"
                            class="text-red-500 hover:text-red-700">
                        删除
                    </button>
                </div>
            </div>
            
            <!-- 添加标签表单 -->
            <div v-if="showLabelForm" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center">
                <div class="bg-white rounded-lg p-6 w-96">
                    <h3 class="text-lg font-semibold mb-4">添加推特标</h3>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700">推特链接</label>
                            <input v-model="newLabel.twitterUrl" 
                                   type="text"
                                   class="mt-1 block w-full rounded border-gray-300 shadow-sm">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">标签名称</label>
                            <input v-model="newLabel.label" 
                                   type="text"
                                   class="mt-1 block w-full rounded border-gray-300 shadow-sm">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">标签颜色</label>
                            <input v-model="newLabel.color" 
                                   type="color"
                                   class="mt-1 block w-full rounded border-gray-300 shadow-sm">
                        </div>
                    </div>
                    <div class="mt-6 flex justify-end space-x-3">
                        <button @click="showLabelForm = false"
                                class="px-4 py-2 text-gray-600 hover:text-gray-800">
                            取消
                        </button>
                        <button @click="saveTwitterLabel"
                                class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600">
                            保存
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="/js/app.js"></script>
</body>
</html> 